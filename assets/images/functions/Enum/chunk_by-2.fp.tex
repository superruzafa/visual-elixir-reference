\matrix [list=a] {
  \node [index=1]; &
  \node [index=2]; &
  \node [index=3]; &
  \node [index=4]; &
  \node [index=5]; &
  \node [index=6]; &
  \node [elements after]; \\
};

\foreach \i/\r in {1/1, 2/1, 3/2, 4/1, 5/3, 6/3}{
  \applyfuntop{a\i.north}{\texttt{fun}}{$k_\r$}
  \coordinate (k\i) at (last label);
}

\draw [rounded corners=2.5mm] ($ (k1.mid) + (-.25, -.25) $) rectangle ($ (k2.mid) + (.25, .25) $);
\draw (k3.mid) circle [radius=3mm];
\draw (k4.mid) circle [radius=3mm];
\draw [rounded corners=2.5mm] ($ (k5.mid) + (-.25, -.25) $) rectangle ($ (k6.mid) + (.25, .25) $);

\matrix [list=p, element size=1.7cm, below=2 of list a] {
  \node (p1) [placeholder=1.75]; &
  \node (p2) [placeholder=1]; &
  \node (p3) [placeholder=1]; &
  \node (p4) [placeholder=1.75]; &
  \node [elements after]; \\
};

\begin{scope}
  \tikzset{every list/.style={sublist}}
  \matrix [list=b1, element=a] at (p1) {
    \node [index=1]; &
    \node [index=2]; \\
  };
  \matrix [list=b2, element=a] at (p2) {
    \node [index=3]; \\
  };
  \matrix [list=b3, element=a] at (p3) {
    \node [index=4]; \\
  };
  \matrix [list=b4, element=a] at (p4) {
    \node [index=5]; &
    \node [index=6]; \\
  };
\end{scope}

\bracetobrace
  {a2.south east}{a1.south west}
  {p1.north west}{p1.north east}

\draw [->, out=270, in=90] (a3.south) to (p2.north);
\draw [->, out=270, in=90] (a4.south) to (p3.north);

\bracetobrace
  {a6.south east}{a5.south west}
  {p4.north west}{p4.north east}

