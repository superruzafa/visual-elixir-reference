\makeatletter

\pgfkeys{
  funprog/.is family,
  funprog/.search also=/tikz,
}

\let\funprog@datastructtype\empty
\let\funprog@datastructid\empty
\let\funprog@datastructelement\empty

\tikzset{
  every list/.style={},
  list/.forward to={funprog, list},
  index/.forward to={funprog, \funprog@datastructtype/index},
  every list between elements/.style={},
  elements between/.forward to={funprog, \funprog@datastructtype/elements between},
}

\pgfkeys{
  funprog,
  data struct type/.store in=\funprog@datastructtype,
  data struct id/.store in=\funprog@datastructid,
  data struct element/.store in=\funprog@datastructelement,
  list/.style={
    data struct type=list,
    data struct id=#1,
    data struct element=#1,
    name=list #1,
    nodes={
      draw,
      anchor=center,
      inner sep=0pt,
      outer sep=auto,
    },
    column sep=-\pgflinewidth,
    row sep=-\pgflinewidth,
    outer sep=-.5\pgflinewidth,
    inner sep=0pt,
    every list,
  },
  list/index/.style={
    name=\funprog@datastructid#1,
    node contents={$\funprog@datastructelement_{#1}$},
  },
  list/elements between/.style={
    draw=none,
    node contents={},
    append after command={
      \pgfextra
      \draw [dashed]
            (\tikzlastnode.north west) -- (\tikzlastnode.north east)
            (\tikzlastnode.south west) -- (\tikzlastnode.south east);
      \endpgfextra
    },
    every list elements between,
  },
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% function
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\pgfutil@useanchor#1#2{\csname pgf@anchor@#1@#2\endcsname}

\def\funprog@function@north{1}
\def\funprog@function@south{2}
\def\funprog@function@east{3}
\def\funprog@function@west{4}

\let\funprog@function@in\funprog@function@north
\let\funprog@function@out\funprog@function@south
\def\funprog@function@arity{1}

\def\funprog@function@update{
  \pgfkeys{
    /tikz/funprog/function/.cd,
      north ports=0,
      south ports=0,
      east ports=0,
      west ports=0,
  }
  %
  \ifnum\funprog@function@in=\funprog@function@north
  \pgfkeysalso{/tikz/funprog/function/north ports=\funprog@function@arity}
  \fi
  \ifnum\funprog@function@in=\funprog@function@south
  \pgfkeysalso{/tikz/funprog/function/south ports=\funprog@function@arity}
  \fi
  \ifnum\funprog@function@in=\funprog@function@west
  \pgfkeysalso{/tikz/funprog/function/west ports=\funprog@function@arity}
  \fi
  \ifnum\funprog@function@in=\funprog@function@east
  \pgfkeysalso{/tikz/funprog/function/east ports=\funprog@function@arity}
  \fi
  %
  \ifnum\funprog@function@out=\funprog@function@north
  \pgfkeysalso{/tikz/funprog/function/north ports=1}
  \fi
  \ifnum\funprog@function@out=\funprog@function@south
  \pgfkeysalso{/tikz/funprog/function/south ports=1}
  \fi
  \ifnum\funprog@function@out=\funprog@function@west
  \pgfkeysalso{/tikz/funprog/function/west ports=1}
  \fi
  \ifnum\funprog@function@out=\funprog@function@east
  \pgfkeysalso{/tikz/funprog/function/east ports=1}
  \fi
}

\pgfkeys{
  /tikz/funprog/.cd,
    function/.style={
      name=function #1,
      draw,
      shape=function,
      every function,
    },
    function/.cd,
    port width/.initial=2.5mm,
    port height/.initial=1mm,
    port funnel width/.initial=1.75mm,
    port separation/.initial=2.5mm,
    north ports/.initial=1,
    south ports/.initial=1,
    east ports/.initial=0,
    west ports/.initial=0,
    in/.is choice,
    in/north/.code={
      \let\funprog@function@in\funprog@function@north
      \funprog@function@update
    },
    in/south/.code={
      \let\funprog@function@in\funprog@function@south
      \funprog@function@update
    },
    in/east/.code={
      \let\funprog@function@in\funprog@function@east
      \funprog@function@update
    },
    in/west/.code={
      \let\funprog@function@in\funprog@function@west
      \funprog@function@update
    },
    out/.is choice,
    out/north/.code={
      \let\funprog@function@out\funprog@function@north
      \funprog@function@update
    },
    out/south/.code={
      \let\funprog@function@out\funprog@function@south
      \funprog@function@update
    },
    out/east/.code={
      \let\funprog@function@out\funprog@function@east
      \funprog@function@update
    },
    out/west/.code={
      \let\funprog@function@out\funprog@function@west
      \funprog@function@update
    },
    arity/.code={
      \def\funprog@function@arity{#1}
      \funprog@function@update
    },
    in=north,
    out=south,
    arity=1
}

% sets \pgf@x and \pgf@y to the south west corner of the function box
\def\funprog@function@anchor@southwest{
  \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/tikz/funprog/function/port width} + \pgfkeysvalueof{/tikz/funprog/function/port separation}}
  % Calculate x
    %
    % First, is width < minimum width?
    \pgf@x=\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xc{\pgfkeysvalueof{/pgf/inner xsep}}%
    \advance\pgf@x by 2\pgf@xc%
    \pgfmathsetlength\pgf@xb{\pgfkeysvalueof{/pgf/minimum width}}%
    \ifdim\pgf@x<\pgf@xb%
    % yes, too small. Enlarge...
    \pgf@x=\pgf@xb%
    \fi%
    \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/tikz/funprog/function/north ports} * \@tempdima}
    \ifdim\pgf@x<\pgf@xa%
    % yes, too small. Enlarge...
    \pgf@x=\pgf@xa%
    \fi%
    \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/tikz/funprog/function/south ports} * \@tempdima}
    \ifdim\pgf@x<\pgf@xa%
    % yes, too small. Enlarge...
    \pgf@x=\pgf@xa%
    \fi%
    % Now, calculate left border: .5\wd\pgfnodeparttextbox - .5 \pgf@x - outer sep
    \pgf@x=-.5\pgf@x%
    \advance\pgf@x by.5\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/pgf/outer xsep}}%
    \advance\pgf@x by-\pgf@xa%
    % Calculate y
    %
    % First, is height+depth < minimum height?
    \pgf@y=\ht\pgfnodeparttextbox%
    \advance\pgf@y by\dp\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@yc{\pgfkeysvalueof{/pgf/inner ysep}}%
    \advance\pgf@y by 2\pgf@yc%
    \pgfmathsetlength\pgf@yb{\pgfkeysvalueof{/pgf/minimum height}}%
    \ifdim\pgf@y<\pgf@yb%
    % yes, too small. Enlarge...
    \pgf@y=\pgf@yb%
    \fi%
    \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/tikz/funprog/function/east ports} * \@tempdima}
    \ifdim\pgf@y<\pgf@ya%
    % yes, too small. Enlarge...
    \pgf@y=\pgf@ya%
    \fi%
    \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/tikz/funprog/function/west ports} * \@tempdima}
    \ifdim\pgf@y<\pgf@ya%
    % yes, too small. Enlarge...
    \pgf@y=\pgf@ya%
    \fi%
    % Now, calculate upper border: .5\ht-.5\dp - .5 \pgf@y - outer sep
    \pgf@y=-.5\pgf@y%
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox%
    \advance\pgf@y by.5\ht\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/pgf/outer ysep}}%
    \advance\pgf@y by-\pgf@ya%
}

% sets \pgf@x and \pgf@y to the north east corner of the function box
\def\funprog@function@anchor@northeast{
  \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/tikz/funprog/function/port width} + \pgfkeysvalueof{/tikz/funprog/function/port separation}}
  % Calculate x
    %
    % First, is width < minimum width?
    \pgf@x=\the\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xc{\pgfkeysvalueof{/pgf/inner xsep}}%
    \advance\pgf@x by 2\pgf@xc%
    \pgfmathsetlength\pgf@xb{\pgfkeysvalueof{/pgf/minimum width}}%
    \ifdim\pgf@x<\pgf@xb%
    % yes, too small. Enlarge...
    \pgf@x=\pgf@xb%
    \fi%
    \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/tikz/funprog/function/north ports} * \@tempdima}
    \ifdim\pgf@x<\pgf@xa%
    % yes, too small. Enlarge...
    \pgf@x=\pgf@xa%
    \fi%
    \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/tikz/funprog/function/south ports} * \@tempdima}
    \ifdim\pgf@x<\pgf@xa%
    % yes, too small. Enlarge...
    \pgf@x=\pgf@xa%
    \fi%
    % Now, calculate right border: .5\wd\pgfnodeparttextbox + .5 \pgf@x + outer sep
    \pgf@x=.5\pgf@x%
    \advance\pgf@x by.5\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/pgf/outer xsep}}%
    \advance\pgf@x by\pgf@xa%
    % Calculate y
    %
    % First, is height+depth < minimum height?
    \pgf@y=\ht\pgfnodeparttextbox%
    \advance\pgf@y by\dp\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@yc{\pgfkeysvalueof{/pgf/inner ysep}}%
    \advance\pgf@y by 2\pgf@yc%
    \pgfmathsetlength\pgf@yb{\pgfkeysvalueof{/pgf/minimum height}}%
    \ifdim\pgf@y<\pgf@yb%
    % yes, too small. Enlarge...
    \pgf@y=\pgf@yb%
    \fi%
    \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/tikz/funprog/function/east ports} * \@tempdima}
    \ifdim\pgf@y<\pgf@ya%
    % yes, too small. Enlarge...
    \pgf@y=\pgf@ya%
    \fi%
    \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/tikz/funprog/function/west ports} * \@tempdima}
    \ifdim\pgf@y<\pgf@ya%
    % yes, too small. Enlarge...
    \pgf@y=\pgf@ya%
    \fi%
    % Now, calculate upper border: .5\ht-.5\dp + .5 \pgf@y + outer sep
    \pgf@y=.5\pgf@y%
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox%
    \advance\pgf@y by.5\ht\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/pgf/outer ysep}}%
    \advance\pgf@y by\pgf@ya%
}

% draws a port
\def\funprog@function@portpath{
  \pgf@xa=0pt
    \pgf@ya=0pt
    \advance\pgf@xa by\halfportseparation
    \advance\pgf@xa by\halfportshadow
    \pgfpathlineto{\pgfqpoint{\pgf@xa}{\pgf@ya}}
    \pgf@xb=\pgf@xa \pgf@yb=\pgf@ya
    \advance\pgf@xa by-\halfportshadow
    \advance\pgf@ya by\portheight
    {
      \edef\funprog@xa{\the\pgf@xa}
      \edef\funprog@ya{\the\pgf@ya}
      \edef\funprog@xb{\the\pgf@xb}
      \edef\funprog@yb{\the\pgf@yb}
      \pgfcurveto
      {\pgfpoint{\funprog@xb}{\funprog@yb + \halfportheight}}
      {\pgfpoint{\funprog@xa}{\funprog@ya - \halfportheight}}
      {\pgfpoint{\funprog@xa}{\funprog@ya}}
    }
    \pgf@xb=\pgf@xa \pgf@yb=\pgf@ya
    \advance\pgf@xa by\portwidth
    \pgfpathlineto{\pgfqpoint{\pgf@xa}{\pgf@ya}}

    \pgf@xb=\pgf@xa \pgf@yb=\pgf@ya
    \advance\pgf@xa by-\halfportshadow
    \advance\pgf@ya by-\portheight
    {
      \edef\funprog@xa{\the\pgf@xa}
      \edef\funprog@ya{\the\pgf@ya}
      \edef\funprog@xb{\the\pgf@xb}
      \edef\funprog@yb{\the\pgf@yb}
      \pgfcurveto
      {\pgfpoint{\funprog@xb}{\funprog@yb - \halfportheight}}
      {\pgfpoint{\funprog@xa}{\funprog@ya + \halfportheight}}
      {\pgfpoint{\funprog@xa}{\funprog@ya}}
    }
  % \pgfpathlineto{\pgfqpoint{\pgf@xa}{\pgf@ya}}
    \advance\pgf@xa by\halfportshadow
    \advance\pgf@xa by\halfportseparation
    \pgfpathlineto{\pgfqpoint{\pgf@xa}{\pgf@ya}}
}

\pgfdeclareshape{function}{%
  \inheritanchor[from=rectangle]{base}
  \inheritanchor[from=rectangle]{center}
  \inheritanchor[from=rectangle]{mid}
  \inheritanchor[from=rectangle]{north west}
  \inheritanchor[from=rectangle]{north east}
  \inheritanchor[from=rectangle]{south east}
  \inheritanchor[from=rectangle]{south west}

  \savedanchor\southwest{%
    \funprog@function@anchor@southwest
  }

  \savedanchor\northeast{%
    \funprog@function@anchor@northeast
  }

  \savedanchor\northeastincludingports{
    \pgf@process{\funprog@function@anchor@northeast}
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/north ports}>0
      \advance\pgf@y by\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/east ports}>0
      \advance\pgf@x by\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
  }

  \savedanchor\southwestincludingports{
    \funprog@function@anchor@southwest
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/south ports}>0
      \advance\pgf@y by-\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/west ports}>0
      \advance\pgf@x by-\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
  }

  \savedanchor\firstin{
    \ifnum\funprog@function@in=\funprog@function@north
      \pgf@process{\funprog@function@anchor@southwest} \pgf@xa=\pgf@x
      \pgf@process{\funprog@function@anchor@northeast}
      \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
      \advance \pgf@y by\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@xa}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@xb}
      \pgfkeysgetvalue{/tikz/funprog/function/north ports}{\pgf@xc}
      \pgfmathsetlength\@tempdima{\pgf@xc * (\pgf@xa + \pgf@xb)}
      \advance \pgf@x by-.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@xa / 2 + \pgf@xb / 2}
      \advance \pgf@x by\@tempdima
    \fi
    \ifnum\funprog@function@in=\funprog@function@south
      \pgf@process{\funprog@function@anchor@northeast} \pgf@xa=\pgf@x
      \pgf@process{\funprog@function@anchor@southwest}
      \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
      \advance \pgf@y by-\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@xa}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@xb}
      \pgfkeysgetvalue{/tikz/funprog/function/south ports}{\pgf@xc}
      \pgfmathsetlength\@tempdima{\pgf@xc * (\pgf@xa + \pgf@xb)}
      \advance \pgf@x by-.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@xa / 2 + \pgf@xb / 2}
      \advance \pgf@x by\@tempdima
    \fi
    \ifnum\funprog@function@in=\funprog@function@east
      \pgf@process{\funprog@function@anchor@southwest} \pgf@ya=\pgf@y
      \pgf@process{\funprog@function@anchor@northeast}
      \pgfmathsetlength\pgf@y{.5 * (\pgf@y + \pgf@ya)}
      \advance \pgf@x by\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@ya}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@yb}
      \pgfkeysgetvalue{/tikz/funprog/function/east ports}{\pgf@yc}
      \pgfmathsetlength\@tempdima{\pgf@yc * (\pgf@ya + \pgf@yb)}
      \advance \pgf@y by.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@ya / 2 + \pgf@yb / 2}
      \advance \pgf@y by-\@tempdima
    \fi
    \ifnum\funprog@function@in=\funprog@function@west
      \pgf@process{\funprog@function@anchor@northeast} \pgf@ya=\pgf@y
      \pgf@process{\funprog@function@anchor@southwest}
      \pgfmathsetlength\pgf@y{.5 * (\pgf@y + \pgf@ya)}
      \advance \pgf@x by-\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@ya}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@yb}
      \pgfkeysgetvalue{/tikz/funprog/function/west ports}{\pgf@yc}
      \pgfmathsetlength\@tempdima{\pgf@yc * (\pgf@ya + \pgf@yb)}
      \advance \pgf@y by.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@ya / 2 + \pgf@yb / 2}
      \advance \pgf@y by-\@tempdima
    \fi
  }

  \savedanchor\secondin{
    \ifnum\funprog@function@in=\funprog@function@north
      \pgf@process{\funprog@function@anchor@southwest} \pgf@xa=\pgf@x
      \pgf@process{\funprog@function@anchor@northeast}
      \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
      \advance \pgf@y by\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@xa}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@xb}
      \pgfkeysgetvalue{/tikz/funprog/function/north ports}{\pgf@xc}
      \pgfmathsetlength\@tempdima{\pgf@xc * (\pgf@xa + \pgf@xb)}
      \advance \pgf@x by-.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@xa / 2 + \pgf@xb / 2}
      \advance \pgf@x by\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@xa + \pgf@xb}
      \advance \pgf@x by\@tempdima
    \fi
    \ifnum\funprog@function@in=\funprog@function@south
      \pgf@process{\funprog@function@anchor@northeast} \pgf@xa=\pgf@x
      \pgf@process{\funprog@function@anchor@southwest}
      \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
      \advance \pgf@y by-\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@xa}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@xb}
      \pgfkeysgetvalue{/tikz/funprog/function/south ports}{\pgf@xc}
      \pgfmathsetlength\@tempdima{\pgf@xc * (\pgf@xa + \pgf@xb)}
      \advance \pgf@x by-.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@xa / 2 + \pgf@xb / 2}
      \advance \pgf@x by\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@xa + \pgf@xb}
      \advance \pgf@x by\@tempdima
    \fi
    \ifnum\funprog@function@in=\funprog@function@east
      \pgf@process{\funprog@function@anchor@southwest} \pgf@ya=\pgf@y
      \pgf@process{\funprog@function@anchor@northeast}
      \pgfmathsetlength\pgf@y{.5*(\pgf@y + \pgf@ya)}
      \advance \pgf@x by\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@ya}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@yb}
      \pgfkeysgetvalue{/tikz/funprog/function/east ports}{\pgf@yc}
      \pgfmathsetlength\@tempdima{\pgf@yc * (\pgf@ya + \pgf@yb)}
      \advance \pgf@y by.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@ya / 2 + \pgf@yb / 2}
      \advance \pgf@y by-\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@ya + \pgf@yb}
      \advance \pgf@y by-\@tempdima
    \fi
    \ifnum\funprog@function@in=\funprog@function@west
      \pgf@process{\funprog@function@anchor@northeast} \pgf@ya=\pgf@y
      \pgf@process{\funprog@function@anchor@southwest}
      \pgfmathsetlength\pgf@y{.5*(\pgf@y + \pgf@ya)}
      \advance \pgf@x by-\pgfkeysvalueof{/tikz/funprog/function/port height}
      \pgfkeysgetvalue{/tikz/funprog/function/port width}{\pgf@ya}
      \pgfkeysgetvalue{/tikz/funprog/function/port separation}{\pgf@yb}
      \pgfkeysgetvalue{/tikz/funprog/function/west ports}{\pgf@yc}
      \pgfmathsetlength\@tempdima{\pgf@yc * (\pgf@ya + \pgf@yb)}
      \advance \pgf@y by.5\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@ya / 2 + \pgf@yb / 2}
      \advance \pgf@y by-\@tempdima
      \pgfmathsetlength\@tempdima{\pgf@ya + \pgf@yb}
      \advance \pgf@y by-\@tempdima
    \fi
  }

  \savedanchor\out{
    \ifnum\funprog@function@out=\funprog@function@north
      \pgf@process{\funprog@function@anchor@southwest} \pgf@xa=\pgf@x
      \pgf@process{\funprog@function@anchor@northeast}
      \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
      \advance \pgf@y by\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
    \ifnum\funprog@function@out=\funprog@function@south
      \pgf@process{\funprog@function@anchor@northeast} \pgf@xa=\pgf@x
      \pgf@process{\funprog@function@anchor@southwest}
      \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
      \advance \pgf@y by-\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
    \ifnum\funprog@function@out=\funprog@function@east
      \pgf@process{\funprog@function@anchor@southwest} \pgf@ya=\pgf@y
      \pgf@process{\funprog@function@anchor@northeast}
      \pgfmathsetlength\pgf@y{.5*(\pgf@y + \pgf@ya)}
      \advance \pgf@x by\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
    \ifnum\funprog@function@out=\funprog@function@west
      \pgf@process{\funprog@function@anchor@northeast} \pgf@ya=\pgf@y
      \pgf@process{\funprog@function@anchor@southwest}
      \pgfmathsetlength\pgf@y{.5*(\pgf@y + \pgf@ya)}
      \advance \pgf@x by-\pgfkeysvalueof{/tikz/funprog/function/port height}
    \fi
  }

  \savedanchor\centerpoint{%
    \pgf@x = .5\wd\pgfnodeparttextbox
    \pgf@y = .5\ht\pgfnodeparttextbox
  }

  \saveddimen\northportswidth{
    \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/tikz/funprog/function/north ports} * (\pgfkeysvalueof{/tikz/funprog/function/port width} + \pgfkeysvalueof{/tikz/funprog/function/port separation})}
  }

  \saveddimen\southportswidth{
    \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/tikz/funprog/function/south ports} * (\pgfkeysvalueof{/tikz/funprog/function/port width} + \pgfkeysvalueof{/tikz/funprog/function/port separation})}
  }

  \saveddimen\eastportswidth{
    \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/tikz/funprog/function/east ports} * (\pgfkeysvalueof{/tikz/funprog/function/port width} + \pgfkeysvalueof{/tikz/funprog/function/port separation})}
  }

  \saveddimen\westportswidth{
    \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/tikz/funprog/function/west ports} * (\pgfkeysvalueof{/tikz/funprog/function/port width} + \pgfkeysvalueof{/tikz/funprog/function/port separation})}
  }

  \saveddimen\halfportseparation{
    \pgfmathsetlength\pgf@x{.5 * \pgfkeysvalueof{/tikz/funprog/function/port separation}}
  }

  \saveddimen\portseparation{
    \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/tikz/funprog/function/port separation}}
  }

  \saveddimen\portheight{
    \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/tikz/funprog/function/port height}}
  }

  \saveddimen\halfportheight{
    \pgfmathsetlength\pgf@x{.5 * \pgfkeysvalueof{/tikz/funprog/function/port height}}
  }

  \saveddimen\portwidth{
    \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/tikz/funprog/function/port width}}
  }

  \saveddimen\halfportshadow{
    \pgfmathsetlength\pgf@x{.5 * (\pgfkeysvalueof{/tikz/funprog/function/port width} - \pgfkeysvalueof{/tikz/funprog/function/port funnel width})}
  }

  \anchor{north excluding ports}{
    \pgf@process{\southwest} \pgf@xa=\pgf@x
    \pgf@process{\northeast}
    \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
  }

  \anchor{north}{
    \pgfutil@useanchor{function}{north excluding ports} \pgf@xa=\pgf@x
    \pgf@process{\northeastincludingports}
    \pgf@x=\pgf@xa
  }

  \anchor{south excluding ports}{
    \pgf@process{\northeast} \pgf@xa=\pgf@x
    \pgf@process{\southwest}
    \pgfmathsetlength\pgf@x{.5*(\pgf@x + \pgf@xa)}
  }

  \anchor{south}{
    \pgfutil@useanchor{function}{south excluding ports} \pgf@xa=\pgf@x
    \pgf@process{\southwestincludingports}
    \pgf@x=\pgf@xa
  }

  \anchor{east excluding ports}{
    \pgf@process{\southwest} \pgf@ya=\pgf@y
    \pgf@process{\northeast}
    \pgfmathsetlength\pgf@y{.5*(\pgf@y + \pgf@ya)}
  }

  \anchor{east}{
    \pgfutil@useanchor{function}{east excluding ports} \pgf@ya=\pgf@y
    \pgf@process{\northeastincludingports}
    \pgf@y=\pgf@ya
  }

  \anchor{west excluding ports}{
    \pgf@process{\northeast} \pgf@ya=\pgf@y
    \pgf@process{\southwest}
    \pgfmathsetlength\pgf@y{.5*(\pgf@y + \pgf@ya)}
  }

  \anchor{west}{
    \pgfutil@useanchor{function}{west excluding ports} \pgf@ya=\pgf@y
    \pgf@process{\southwestincludingports}
    \pgf@y=\pgf@ya
  }

  \anchor{in}{
    \firstin
  }

  \anchor{in 1}{
    \firstin
  }

  \anchor{in 2}{
    \secondin
  }

  \anchor{in 3}{
    \pgf@process{\secondin} \pgf@xa=\pgf@x \pgf@ya=\pgf@y
    \pgf@process{\firstin}
    \pgfmathsetlength\pgf@xa{\pgf@xa - \pgf@x}
    \pgfmathsetlength\pgf@ya{\pgf@ya - \pgf@y}
    \pgfmathsetlength\pgf@x{\pgf@x + \pgf@xa * 2}
    \pgfmathsetlength\pgf@y{\pgf@y + \pgf@ya * 2}
  }

  \anchor{in 4}{
    \pgf@process{\secondin} \pgf@xa=\pgf@x \pgf@ya=\pgf@y
    \pgf@process{\firstin}
    \pgfmathsetlength\pgf@xa{\pgf@xa - \pgf@x}
    \pgfmathsetlength\pgf@ya{\pgf@ya - \pgf@y}
    \pgfmathsetlength\pgf@x{\pgf@x + \pgf@xa * 3}
    \pgfmathsetlength\pgf@y{\pgf@y + \pgf@ya * 3}
  }

  \anchor{out}{
    \out
  }

  \backgroundpath{
    \pgf@process{\southwest} \pgf@xa=\pgf@x \pgf@ya=\pgf@y
    \pgf@process{\northeast} \pgf@xb=\pgf@x \pgf@yb=\pgf@y

    % go to the north west corner
    \pgf@xc=\pgf@xa
    \pgf@yc=\pgf@yb
    \pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    % go to the beginning of north ports
    \pgfmathsetlength\@tempdima{((\pgf@xb - \pgf@xa) - \northportswidth) / 2}
    \advance\pgf@xc by\@tempdima
    \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    % draw the north ports
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/north ports}>0
      \foreach \i in {1,...,\pgfkeysvalueof{/tikz/funprog/function/north ports}} {
        \pgftransformshift{\pgfpoint{\pgf@xc}{\pgf@yc}}
        {\funprog@function@portpath}
        \pgftransformreset
        \global\advance\pgf@xc by\portseparation
        \global\advance\pgf@xc by\portwidth
      }
    \fi

    % go to the north east corner
    \pgf@xc=\pgf@xb
    \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    %go to the beginning of east ports
    \pgfmathsetlength\@tempdima{((\pgf@yb - \pgf@ya) - \eastportswidth) / 2}
    \advance\pgf@yc by-\@tempdima
    \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    % draw the east ports
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/east ports}>0
      \foreach \i in {1,...,\pgfkeysvalueof{/tikz/funprog/function/east ports}} {
        \pgftransformshift{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgftransformrotate{-90}
        {\funprog@function@portpath}
        \pgftransformreset
        \global\advance\pgf@yc by-\portseparation
        \global\advance\pgf@yc by-\portwidth
      }
    \fi

    % go to the south east corner
    \pgf@yc=\pgf@ya
    \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    % go to the starting of south ports
    \pgfmathsetlength\@tempdima{((\pgf@xb - \pgf@xa) - \southportswidth) / 2}
    \advance\pgf@xc by-\@tempdima
    \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    % draw the south ports
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/south ports}>0
      \foreach \i in {1,...,\pgfkeysvalueof{/tikz/funprog/function/south ports}} {
        \pgftransformshift{\pgfpoint{\pgf@xc}{\pgf@yc}}
        \pgftransformscale{-1}
        {\funprog@function@portpath}
        \pgftransformreset
        \global\advance\pgf@xc by-\portseparation
        \global\advance\pgf@xc by-\portwidth
      }
    \fi

    % go to the south east corner
    \pgf@xc=\pgf@xa
    \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    %go to the beginning of west ports
    \pgfmathsetlength\@tempdima{((\pgf@yb - \pgf@ya) - \westportswidth) / 2}
    \advance\pgf@yc by\@tempdima
    \pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc}}

    % draw the east ports
    \ifnum\pgfkeysvalueof{/tikz/funprog/function/west ports}>0
    \foreach \i in {1,...,\pgfkeysvalueof{/tikz/funprog/function/west ports}} {
      \pgftransformshift{\pgfpoint{\pgf@xc}{\pgf@yc}}
      \pgftransformrotate{90}
      {\funprog@function@portpath}
      \pgftransformreset
      \global\advance\pgf@yc by\portseparation
      \global\advance\pgf@yc by\portwidth
    }
    \fi

    \pgfpathclose
  }
}

\makeatother

